<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Service Worker | Jay&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/codecat.jpeg">
    <meta name="description" content="贾一倍的个人网站">
    
    <link rel="preload" href="/assets/css/0.styles.35bcedcf.css" as="style"><link rel="preload" href="/assets/js/app.ffeb74c7.js" as="script"><link rel="preload" href="/assets/js/2.8c000b42.js" as="script"><link rel="preload" href="/assets/js/39.dfcb747a.js" as="script"><link rel="prefetch" href="/assets/js/10.d264db59.js"><link rel="prefetch" href="/assets/js/11.0bca9d9a.js"><link rel="prefetch" href="/assets/js/12.4f250ebe.js"><link rel="prefetch" href="/assets/js/13.e66cb20f.js"><link rel="prefetch" href="/assets/js/14.e9740e5f.js"><link rel="prefetch" href="/assets/js/15.77f24c1c.js"><link rel="prefetch" href="/assets/js/16.81145a00.js"><link rel="prefetch" href="/assets/js/17.fecbbc6a.js"><link rel="prefetch" href="/assets/js/18.fa64136a.js"><link rel="prefetch" href="/assets/js/19.0bf73149.js"><link rel="prefetch" href="/assets/js/20.ecf66ee0.js"><link rel="prefetch" href="/assets/js/21.9b56c347.js"><link rel="prefetch" href="/assets/js/22.eba330b8.js"><link rel="prefetch" href="/assets/js/23.cdfc8136.js"><link rel="prefetch" href="/assets/js/24.ecbff0b4.js"><link rel="prefetch" href="/assets/js/25.a765f52f.js"><link rel="prefetch" href="/assets/js/26.1df3f3be.js"><link rel="prefetch" href="/assets/js/27.6d559f57.js"><link rel="prefetch" href="/assets/js/28.44d0a27d.js"><link rel="prefetch" href="/assets/js/29.0db53b84.js"><link rel="prefetch" href="/assets/js/3.593bb0f3.js"><link rel="prefetch" href="/assets/js/30.ecd999ba.js"><link rel="prefetch" href="/assets/js/31.52600e5f.js"><link rel="prefetch" href="/assets/js/32.32943b2d.js"><link rel="prefetch" href="/assets/js/33.362f4d59.js"><link rel="prefetch" href="/assets/js/34.d0944a8e.js"><link rel="prefetch" href="/assets/js/35.bf1908ad.js"><link rel="prefetch" href="/assets/js/36.2d9be9dc.js"><link rel="prefetch" href="/assets/js/37.3358ac3c.js"><link rel="prefetch" href="/assets/js/38.bae9ecf2.js"><link rel="prefetch" href="/assets/js/4.01f7dd6c.js"><link rel="prefetch" href="/assets/js/40.dbf6c454.js"><link rel="prefetch" href="/assets/js/41.a517905d.js"><link rel="prefetch" href="/assets/js/42.e1ae6c7e.js"><link rel="prefetch" href="/assets/js/43.c20697cd.js"><link rel="prefetch" href="/assets/js/44.d5c401fa.js"><link rel="prefetch" href="/assets/js/45.810ad2fb.js"><link rel="prefetch" href="/assets/js/46.cfe99c5e.js"><link rel="prefetch" href="/assets/js/47.32a6c154.js"><link rel="prefetch" href="/assets/js/48.be512d65.js"><link rel="prefetch" href="/assets/js/49.d36d3e6d.js"><link rel="prefetch" href="/assets/js/5.eb23ea04.js"><link rel="prefetch" href="/assets/js/50.4312a7d3.js"><link rel="prefetch" href="/assets/js/51.8db2277f.js"><link rel="prefetch" href="/assets/js/52.0ae05eb4.js"><link rel="prefetch" href="/assets/js/53.e61fc25e.js"><link rel="prefetch" href="/assets/js/54.0f5b381c.js"><link rel="prefetch" href="/assets/js/55.c7beb55c.js"><link rel="prefetch" href="/assets/js/56.97fa88fd.js"><link rel="prefetch" href="/assets/js/57.1e086f28.js"><link rel="prefetch" href="/assets/js/58.97111a0a.js"><link rel="prefetch" href="/assets/js/59.8865259a.js"><link rel="prefetch" href="/assets/js/6.516e3b20.js"><link rel="prefetch" href="/assets/js/60.0541b26f.js"><link rel="prefetch" href="/assets/js/61.624fbdfa.js"><link rel="prefetch" href="/assets/js/62.e71bbf4a.js"><link rel="prefetch" href="/assets/js/63.ad78749d.js"><link rel="prefetch" href="/assets/js/64.931d419d.js"><link rel="prefetch" href="/assets/js/65.b46213b4.js"><link rel="prefetch" href="/assets/js/66.92c8d024.js"><link rel="prefetch" href="/assets/js/67.c63280ef.js"><link rel="prefetch" href="/assets/js/68.16012c5b.js"><link rel="prefetch" href="/assets/js/69.b4a8ea96.js"><link rel="prefetch" href="/assets/js/7.c7625e6b.js"><link rel="prefetch" href="/assets/js/70.c03c3735.js"><link rel="prefetch" href="/assets/js/71.76491655.js"><link rel="prefetch" href="/assets/js/72.ab24e160.js"><link rel="prefetch" href="/assets/js/73.9026af07.js"><link rel="prefetch" href="/assets/js/74.8f925ea4.js"><link rel="prefetch" href="/assets/js/75.8c3d4d08.js"><link rel="prefetch" href="/assets/js/76.2e25789c.js"><link rel="prefetch" href="/assets/js/77.bc9764be.js"><link rel="prefetch" href="/assets/js/78.d13a2495.js"><link rel="prefetch" href="/assets/js/8.80450da7.js"><link rel="prefetch" href="/assets/js/9.dd8d6c7c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35bcedcf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jay's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/accumulate/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/stack/" class="nav-link">
  技术栈
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="/browser/" class="nav-link router-link-active">
  浏览器
</a></div><div class="nav-item"><a href="/network/" class="nav-link">
  计算机网络
</a></div><div class="nav-item"><a href="/optimize/" class="nav-link">
  优化
</a></div><div class="nav-item"><a href="/c++/" class="nav-link">
  c++
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/accumulate/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/stack/" class="nav-link">
  技术栈
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="/browser/" class="nav-link router-link-active">
  浏览器
</a></div><div class="nav-item"><a href="/network/" class="nav-link">
  计算机网络
</a></div><div class="nav-item"><a href="/optimize/" class="nav-link">
  优化
</a></div><div class="nav-item"><a href="/c++/" class="nav-link">
  c++
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Browser</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/browser/" aria-current="page" class="sidebar-link">浏览器相关</a></li><li><a href="/browser/ServiceWorker.html" aria-current="page" class="active sidebar-link">Service Worker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/browser/ServiceWorker.html#原理" class="sidebar-link">原理</a></li><li class="sidebar-sub-header"><a href="/browser/ServiceWorker.html#service-worker主要事件" class="sidebar-link">Service Worker主要事件</a></li><li class="sidebar-sub-header"><a href="/browser/ServiceWorker.html#service-worker应用" class="sidebar-link">Service Worker应用</a></li></ul></li><li><a href="/browser/htmlcssjs加载顺序.html" class="sidebar-link">加载解析过程</a></li><li><a href="/browser/缓存.html" class="sidebar-link">缓存的好处</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="service-worker"><a href="#service-worker" class="header-anchor">#</a> Service Worker</h1> <p><code>Service Worker</code>是浏览器在后台独立于网页运行的、用JavaScript编写的脚本，可以拦截HTTP请求</p> <h2 id="原理"><a href="#原理" class="header-anchor">#</a> <strong>原理</strong></h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 不起眼的一行if，除了防止报错之外，也无意间解释了PWA的P：</span>
<span class="token comment">// 如果浏览器不支持Service Worker，那就当什么都没有发生过</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 所以Service Worker只是一个挂在navigator对象上的HTML5 API而已</span>
        navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/service-worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">registration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我注册成功了666'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我注册失败了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// service-worker.js</span>
<span class="token comment">// 虽然可以在里边为所欲为地写任何js代码，或者也可以什么都不写，</span>
<span class="token comment">// 都不妨碍这是一个Service Worker，但还是举一个微小的例子：</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.png$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/images/支付宝收款码.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><ol><li>首次导航到网站时，会下载、解析并执行Service Worker文件，触发install事件，尝试安装Service Worker，如果install事件回调函数中的操作都执行成功，标志Service Worker安装成功，此时进入waiting状态</li> <li>当用户二次进入网站时，才会激活Service Worker，此时会触发activate事件，标志Service Worker正式启动，开始响应fetch、post、sync等事件。</li></ol> <hr> <h2 id="service-worker主要事件"><a href="#service-worker主要事件" class="header-anchor">#</a> <strong>Service Worker主要事件</strong></h2> <ul><li><p>install：Service Worker安装时触发，通常在这个时机缓存文件。</p></li> <li><p>activate：Service Worker激活时触发，通常在这个时机做一些重置的操作，例如处理旧版本Service Worker的缓存。</p></li> <li><p>fetch：浏览器发起HTTP请求时触发，通常在这个事件的回调函数中匹配缓存，是最常用的事件。</p></li> <li><p>push：顾名思义，和推送通知功能相关</p></li> <li><p>sync：顾名思义，和后台同步功能相关</p></li></ul> <hr> <h2 id="service-worker应用"><a href="#service-worker应用" class="header-anchor">#</a> <strong>Service Worker应用</strong></h2> <ul><li>缓存静态资源</li></ul> <p>利用CacheStorage API来缓存js、css、字体、图片等静态文件。我们可以在Service Worker的install阶段，指定需要缓存的具体文件，在fetch事件的回调函数中，检查请求的url，如果匹配了已缓存的资源，则不再从服务端获取，以此达到提升网页性能的目的</p> <ul><li>离线体验</li></ul> <p>缓存页面实现离线查看，但访问的总是缓存过的页面，不能获取到新页面，可以再activate阶段重置缓存；或者离线时返回一个离线页面</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/browser/" class="prev router-link-active">
        浏览器相关
      </a></span> <span class="next"><a href="/browser/htmlcssjs加载顺序.html">
        加载解析过程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ffeb74c7.js" defer></script><script src="/assets/js/2.8c000b42.js" defer></script><script src="/assets/js/39.dfcb747a.js" defer></script>
  </body>
</html>
